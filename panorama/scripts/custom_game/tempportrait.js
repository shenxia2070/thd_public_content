//以后会考虑废弃这个常量表直接按thd2_xxx.png的格式载入
//目前表仅用于表示该英雄的资源文件是否存在,后面的路径不会被使用
var imagefile = {
	'npc_dota_hero_lina': 'panorama/images/heroes/thd2_npc_dota_hero_lina.png',
	'npc_dota_hero_axe': 'panorama/images/heroes/thd2_npc_dota_hero_axe.png',
	'npc_dota_hero_centaur': 'panorama/images/heroes/thd2_npc_dota_hero_centaur.png',
	'npc_dota_hero_chaos_knight': 'panorama/images/heroes/thd2_npc_dota_hero_chaos_knight.png',
	'npc_dota_hero_earthshaker': 'panorama/images/heroes/thd2_npc_dota_hero_earthshaker.png',
	'npc_dota_hero_elder_titan': 'panorama/images/heroes/thd2_npc_dota_hero_elder_titan.png',
	'npc_dota_hero_huskar': 'panorama/images/heroes/thd2_npc_dota_hero_huskar.png',
	'npc_dota_hero_kunkka': 'panorama/images/heroes/thd2_npc_dota_hero_kunkka.png',
	'npc_dota_hero_life_stealer': 'panorama/images/heroes/thd2_npc_dota_hero_life_stealer.png',
	'npc_dota_hero_tidehunter': 'panorama/images/heroes/thd2_npc_dota_hero_tidehunter.png',
	'npc_dota_hero_venomancer': 'panorama/images/heroes/thd2_npc_dota_hero_venomancer.png',
	'npc_dota_hero_sniper': 'panorama/images/heroes/thd2_npc_dota_hero_sniper.png',
	'npc_dota_hero_bounty_hunter': 'panorama/images/heroes/thd2_npc_dota_hero_bounty_hunter.png',
	'npc_dota_hero_clinkz': 'panorama/images/heroes/thd2_npc_dota_hero_clinkz.png',
	'npc_dota_hero_drow_ranger': 'panorama/images/heroes/thd2_npc_dota_hero_drow_ranger.png',
	'npc_dota_hero_juggernaut': 'panorama/images/heroes/thd2_npc_dota_hero_juggernaut.png',
	'npc_dota_hero_mirana': 'panorama/images/heroes/thd2_npc_dota_hero_mirana.png',
	'npc_dota_hero_naga_siren': 'panorama/images/heroes/thd2_npc_dota_hero_naga_siren.png',
	'npc_dota_hero_phantom_assassin': 'panorama/images/heroes/thd2_npc_dota_hero_phantom_assassin.png',
	'npc_dota_hero_razor': 'panorama/images/heroes/thd2_npc_dota_hero_razor.png',
	'npc_dota_hero_slark': 'panorama/images/heroes/thd2_npc_dota_hero_slark.png',
	'npc_dota_hero_crystal_maiden': 'panorama/images/heroes/thd2_npc_dota_hero_crystal_maiden.png',
	'npc_dota_hero_dark_seer': 'panorama/images/heroes/thd2_npc_dota_hero_dark_seer.png',
	'npc_dota_hero_lich': 'panorama/images/heroes/thd2_npc_dota_hero_lich.png',
	'npc_dota_hero_lion': 'panorama/images/heroes/thd2_npc_dota_hero_lion.png',
	'npc_dota_hero_furion': 'panorama/images/heroes/thd2_npc_dota_hero_furion.png',
	'npc_dota_hero_necrolyte': 'panorama/images/heroes/thd2_npc_dota_hero_necrolyte.png',
	'npc_dota_hero_obsidian_destroyer': 'panorama/images/heroes/thd2_npc_dota_hero_obsidian_destroyer.png',
	'npc_dota_hero_silencer': 'panorama/images/heroes/thd2_npc_dota_hero_silencer.png',
	'npc_dota_hero_storm_spirit': 'panorama/images/heroes/thd2_npc_dota_hero_storm_spirit.png',
	'npc_dota_hero_warlock': 'panorama/images/heroes/thd2_npc_dota_hero_warlock.png',
	'npc_dota_hero_zuus': 'panorama/images/heroes/thd2_npc_dota_hero_zuus.png',
	'npc_dota_hero_templar_assassin': 'panorama/images/heroes/thd2_npc_dota_hero_templar_assassin.png',
	'npc_dota_hero_visage': 'panorama/images/heroes/thd2_npc_dota_hero_visage.png',
	'npc_dota_hero_puck': 'panorama/images/heroes/thd2_npc_dota_hero_puck.png',
	'npc_dota_hero_tinker': 'panorama/images/heroes/thd2_npc_dota_hero_tinker.png',
	'npc_dota_hero_viper': 'panorama/images/heroes/thd2_npc_dota_hero_viper.png',
	'npc_dota_hero_rubick': 'panorama/images/heroes/thd2_npc_dota_hero_rubick.png',
	'npc_dota_hero_doom_bringer': 'panorama/images/heroes/thd2_npc_dota_hero_doom_bringer.png',
	'npc_dota_hero_dragon_knight': 'panorama/images/heroes/thd2_npc_dota_hero_dragon_knight.png',
	'npc_dota_hero_dazzle': 'panorama/images/heroes/thd2_npc_dota_hero_dazzle.png',
	'npc_dota_hero_weaver': 'panorama/images/heroes/thd2_npc_dota_hero_weaver.png',
	'npc_dota_hero_vengefulspirit': 'panorama/images/heroes/thd2_npc_dota_hero_vengefulspirit.png',
	'npc_dota_hero_earth_spirit': 'panorama/images/heroes/thd2_npc_dota_hero_earth_spirit.png',
	'npc_dota_hero_night_stalker': 'panorama/images/heroes/thd2_npc_dota_hero_night_stalker.png',
	'npc_dota_hero_mars': 'panorama/images/heroes/thd2_npc_dota_hero_mars.png',
	'npc_dota_hero_luna': 'panorama/images/heroes/thd2_npc_dota_hero_luna.png',
	'npc_dota_hero_invoker': 'panorama/images/heroes/thd2_npc_dota_hero_invoker.png',
	'npc_dota_hero_riki': 'panorama/images/heroes/thd2_npc_dota_hero_riki.png',
	'npc_dota_hero_gyrocopter': 'panorama/images/heroes/thd2_npc_dota_hero_gyrocopter.png',
	'npc_dota_hero_spectre': 'panorama/images/heroes/thd2_npc_dota_hero_spectre.png',
	'npc_dota_hero_legion_commander': 'panorama/images/heroes/thd2_npc_dota_hero_legion_commander.png',
	'npc_dota_hero_phantom_lancer': 'panorama/images/heroes/thd2_npc_dota_hero_phantom_lancer.png',
	'npc_dota_hero_witch_doctor': 'panorama/images/heroes/thd2_npc_dota_hero_witch_doctor.png',
	'npc_dota_hero_lycan': 'panorama/images/heroes/thd2_npc_dota_hero_lycan.png',
	'npc_dota_hero_batrider': 'panorama/images/heroes/thd2_npc_dota_hero_batrider.png',
	'npc_dota_hero_leshrac': 'panorama/images/heroes/thd2_npc_dota_hero_leshrac.png',
	'npc_dota_hero_ursa': 'panorama/images/heroes/thd2_npc_dota_hero_ursa.png',
	'npc_dota_hero_keeper_of_the_light': 'panorama/images/heroes/thd2_npc_dota_hero_keeper_of_the_light.png',
	'npc_dota_hero_sven': 'panorama/images/heroes/thd2_npc_dota_hero_sven.png',
	'npc_dota_hero_rattletrap': 'panorama/images/heroes/thd2_npc_dota_hero_rattletrap.png',
	'npc_dota_hero_terrorblade': 'panorama/images/heroes/thd2_npc_dota_hero_terrorblade.png',
	'npc_dota_hero_ogre_magi': 'panorama/images/heroes/thd2_npc_dota_hero_ogre_magi.png',
	'npc_dota_hero_bane': 'panorama/images/heroes/thd2_npc_dota_hero_bane.png',
	'npc_dota_hero_skywrath_mage': 'panorama/images/heroes/thd2_npc_dota_hero_skywrath_mage.png',
	'npc_dota_hero_broodmother': 'panorama/images/heroes/thd2_npc_dota_hero_broodmother.png',
	'npc_dota_hero_nyx_assassin': 'panorama/images/heroes/thd2_npc_dota_hero_nyx_assassin.png',
	'npc_dota_hero_void_spirit': 'panorama/images/heroes/thd2_npc_dota_hero_void_spirit.png',
	'npc_dota_hero_winter_wyvern': 'panorama/images/heroes/thd2_npc_dota_hero_winter_wyvern.png',
	'npc_dota_hero_pugna': 'panorama/images/heroes/thd2_npc_dota_hero_pugna.png',
	'npc_dota_hero_disruptor': 'panorama/images/heroes/thd2_npc_dota_hero_disruptor.png',
	'npc_dota_hero_omniknight': 'panorama/images/heroes/thd2_npc_dota_hero_omniknight.png',
	'npc_dota_hero_arc_warden': 'panorama/images/heroes/thd2_npc_dota_hero_arc_warden.png',
	'npc_dota_hero_grimstroke': 'panorama/images/heroes/thd2_npc_dota_hero_grimstroke.png',
	'npc_dota_hero_undying': 'panorama/images/heroes/thd2_npc_dota_hero_undying.png',
	'npc_dota_hero_bristleback': 'panorama/images/heroes/thd2_npc_dota_hero_bristleback.png',
	'npc_dota_hero_dawnbreaker': 'panorama/images/heroes/thd2_npc_dota_hero_dawnbreaker.png',
	'npc_dota_hero_death_prophet': 'panorama/images/heroes/thd2_npc_dota_hero_death_prophet.png',
	'npc_dota_hero_tusk': 'panorama/images/heroes/thd2_npc_dota_hero_tusk.png',
	'npc_dota_hero_dark_willow': 'panorama/images/heroes/thd2_npc_dota_hero_dark_willow.png',
}

/////////////////////////////////////////////////////////////
// Loops
function LoopSwapInGameIcons() {
	if (!Game.GameStateIsBefore( DOTA_GameState.DOTA_GAMERULES_STATE_PRE_GAME )) {
		SwapInGameIcons();
	}
	$.Schedule( 5, LoopSwapInGameIcons );
}
function LoopSwapPreGameIcons() {
	if (Game.GameStateIsBefore( DOTA_GameState.DOTA_GAMERULES_STATE_TEAM_SHOWCASE )) {
		SwapPreGameIcons();
		$.Schedule( 0.01, LoopSwapPreGameIcons );
	}
}
function LoopSwapSpectatorIcons() {
	// if (!Players.IsSpectator( Players.GetLocalPlayer())) return;
	if (!Game.GameStateIsBefore( DOTA_GameState.DOTA_GAMERULES_STATE_PRE_GAME )) {
		SwapSpectatorIcons();
	}
	$.Schedule( 0.1, LoopSwapSpectatorIcons );
}

// TopMostPanel cached here
var topmostpanel;

/////////////////////////////////////////////////////////////
// Loops during game to fix hero icons on TopBar and Scoreboard
function SwapInGameIcons() {
	SwapTopBarIcons();
	SwapScoreboardIcons();	
}

var radianttopbar;
var diretopbar;
function SwapTopBarIcons() {
	// get topmostpanel
	if (!topmostpanel) {
		topmostpanel = $.GetContextPanel();
		while( topmostpanel.GetParent()!=null ) {
			topmostpanel = topmostpanel.GetParent();
		}
	}

	// get topbar panel
	if (!radianttopbar) radianttopbar = topmostpanel.FindChildTraverse( 'TopBarRadiantPlayersContainer' );
	if (!diretopbar) diretopbar = topmostpanel.FindChildTraverse( 'TopBarDirePlayersContainer' );

	// Get HeroImages
	var heroimages = [];
	heroimages = FindPanels( radianttopbar, 'DOTAHeroImage', heroimages, 0 );
	heroimages = FindPanels( diretopbar, 'DOTAHeroImage', heroimages, 0 );

	// Replace HeroImages
	for (var i=0; i<heroimages.length; i++) {
		ReplaceIcon( heroimages[i] );
	}
}

var radiantscoreboard;
var direscoreboard;
function SwapScoreboardIcons() {
	// get topmostpanel
	if (!topmostpanel) {
		topmostpanel = $.GetContextPanel();
		while( topmostpanel.GetParent()!=null ) {
			topmostpanel = topmostpanel.GetParent();
		}
	}

	// get scoreboard panel
	if (!radiantscoreboard) radiantscoreboard = topmostpanel.FindChildTraverse( 'RadiantTeamContainer' );
	if (!direscoreboard) direscoreboard = topmostpanel.FindChildTraverse( 'DireTeamContainer' );

	// Get HeroImages
	var heroimages = [];
	heroimages = FindPanels( radiantscoreboard, 'DOTAHeroImage', heroimages, 0 );
	heroimages = FindPanels( direscoreboard, 'DOTAHeroImage', heroimages, 0 );

	// Replace HeroImages
	for (var i=0; i<heroimages.length; i++) {
		ReplaceIcon( heroimages[i] );
	}
}

/////////////////////////////////////////////////////////////
// Loops during pre-game to fix hero icons on TopBar selection
var radiantpregame;
var direpregame;
function SwapPreGameIcons() {
	// get topmostpanel
	if (!topmostpanel) {
		topmostpanel = $.GetContextPanel();
		while( topmostpanel.GetParent()!=null ) {
			topmostpanel = topmostpanel.GetParent();
		}
	}

	// get topbar panel
	if (!radiantpregame) radiantpregame = topmostpanel.FindChildTraverse( 'RadiantTeamPlayers' );
	if (!direpregame) direpregame = topmostpanel.FindChildTraverse( 'DireTeamPlayers' );

	// Get HeroImages
	var heroimages = [];
	heroimages = FindPanels( radiantpregame, 'DOTAHeroImage', heroimages, 0 );
	heroimages = FindPanels( direpregame, 'DOTAHeroImage', heroimages, 0 );

	// Replace HeroImages
	for (var i=0; i<heroimages.length; i++) {
		ReplaceIcon( heroimages[i] );
	}
}

/////////////////////////////////////////////////////////////
// Loops during game to fix hero icons on spectator scoreboard
var playerrows;
function SwapSpectatorIcons() {
	// get topmostpanel
	if (!topmostpanel) {
		topmostpanel = $.GetContextPanel();
		while( topmostpanel.GetParent()!=null ) {
			topmostpanel = topmostpanel.GetParent();
		}
	}

	// get spectator panel
	if (!playerrows) {
		playerrows = topmostpanel.FindChildTraverse( 'spectator_game_stats' );
		if (!playerrows) return;
		playerrows = playerrows.FindChildTraverse( 'PlayerRows' );
		if (!playerrows) return;
	}

	// Get HeroImages
	var heroimages = [];
	heroimages = FindPanels( playerrows, 'DOTAHeroImage', heroimages, 0 );

	// Replace HeroImages
	for (var i=0; i<heroimages.length; i++) {
		ReplaceIcon( heroimages[i] );
	}
}

/////////////////////////////////////
// Collects all child of 'parent' with type 'name'
function FindPanels( parent, name, ret, level ) {
	// if parent can't have children, return
	if (!parent.Children) return ret;
	var children = parent.Children();
	if (children.length<1) return ret;

	// traverse panel's children
	for( var i=0; i<children.length; i++ ) {
		// only for matching
		if (children[i].paneltype==name) {
			ret.push( children[i] );
		}

		// recursive traversal
		ret = FindPanels( children[i], name, ret, level + 1 );
	}

	return ret;
}

// Replaces 'HeroImage' panel to a custom image
function ReplaceIcon( heroimage ) {
	// get HeroImage's name and style
	var heroname = 'npc_dota_hero_' + heroimage.heroname;
	var style = heroimage.heroimagestyle;

	// add new overlay panel if not exist
	var overlay = heroimage.FindChild( 'HeroImageOverlay' );
	if ( overlay==null ) {
		overlay = $.CreatePanel('Panel', heroimage, 'HeroImageOverlay');
		overlay.style.width = '100%';
		overlay.style.height = '100%';
		overlay.style.backgroundSize = '100% 100%';
		overlay.heroname = "";
	}

	// check hero name to reduce computation
	if (heroname!=overlay.heroname && style=='landscape') {
		overlay.heroname = heroname;

		if ( imagefile[heroname] ) {
			// change hero image if available
			overlay.style.backgroundImage = 'url("s2r://panorama/images/heroes/thd2_' + heroname + '.png")';
			//overlay.style.backgroundImage = 'url("s2r://' + imagefile[heroname] + '")';
			overlay.style.visibility = 'visible';
		} else {
			// hide to default if not available
			overlay.style.visibility = 'collapse';
		}
	}
}

/////////////////////////////////////
// Replace Hero Icons in chat
var chat;
var playernames;
var chatinit = false;
function InitSwapChatIcons() {
	// Get all player names and their hero names, store in 'playernames'
	var players = Game.GetAllPlayerIDs();
	playernames = {};
	for( var i in players ) {
		var p = players[i];
		var name = Players.GetPlayerName( p );
		var hero = Players.GetPlayerSelectedHero( p );
		playernames[name] = hero;
	}
}

// Loops during game to replace chat hero icons
function LoopSwapChatIcons() {
	if (!Game.GameStateIsBefore( DOTA_GameState.DOTA_GAMERULES_STATE_PRE_GAME )) {
		InitSwapChatIcons();
		SwapChatIcons();
	}
	$.Schedule( 0.1, LoopSwapChatIcons );
}

// Replace Chat Hero Icons
function SwapChatIcons() {
	// get topmostpanel
	if (!topmostpanel) {
		topmostpanel = $.GetContextPanel();
		while( topmostpanel.GetParent()!=null ) {
			topmostpanel = topmostpanel.GetParent();
		}
	}

	// get chat container
	if (!chat) chat = topmostpanel.FindChildTraverse( 'ChatLinesPanel' );

	// find all Images (not HeroImages, chat are quite different)
	var images = [];
	images = FindPanels( chat, 'Image', images, 0 );

	for( var i in images ) {
		var image = images[i];

		// only heroicon images
		if (!image.BHasClass || !image.BHasClass( 'HeroIcon' )) continue;


		// if image already has been changed by this, pass
		if (image.FindChild( 'HeroImageOverlay' )) continue;

		// find player name who sent the chat
		var text = image.GetParent().text.split(':')[0];
		var player;
		for( var j in playernames ) {
			if ( text.indexOf( j ) != -1 ) {
				player = j;
				break;
			}
		}

		if (!player) return;
		var heroname = playernames[player];

		// add new overlay panel
		var overlay = image.FindChild( 'HeroImageOverlay' );
		if (!overlay) {
			overlay = $.CreatePanel('Panel', image, 'HeroImageOverlay');
			overlay.style.width = '100%';
			overlay.style.height = '100%';
			overlay.style.backgroundSize = '100% 100%';
		}

		if ( imagefile[heroname] ) {
			// change hero image if available
			overlay.style.backgroundImage = 'url("s2r://panorama/images/heroes/thd2_' + heroname + '.png")'
			//overlay.style.backgroundImage = 'url("s2r://' + imagefile[heroname] + '")';
			overlay.style.visibility = 'visible';
		} else {
			// hide to default if not available
			overlay.style.visibility = 'collapse';
		}
	}
}

//---------------------------------------------
// Init
;(function() {
	
	
	$.Msg( "Hello from tempportrait, World!" );

	// run when pregame starts
	GameEvents.Subscribe( 'game_rules_state_change', function() {
		if (Game.GameStateIsBefore( DOTA_GameState.DOTA_GAMERULES_STATE_PRE_GAME )) return;
		SwapInGameIcons();
		SwapSpectatorIcons();
		SwapChatIcons();
	});

	// initiate loops
	LoopSwapPreGameIcons();
	LoopSwapInGameIcons();
	LoopSwapSpectatorIcons();
	LoopSwapChatIcons();
})();
